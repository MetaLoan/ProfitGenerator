<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>åˆçº¦æ¨¡æ‹Ÿè®¡ç®—å™¨ & æ™’å•ç”Ÿæˆå™¨</title>
  <!-- Google Fonts é¢„è¿æ¥ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- html2canvas ç”¨äºæˆªå›¾å¯¼å‡º -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- QRCode.js ç”¨äºäºŒç»´ç é¢„è§ˆ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- HarmonyOS Sans SC å­—ä½“ - å…¨å­—é‡ (æœ¬åœ° + CDN å¤‡ç”¨) -->
  <link rel="stylesheet" href="/fonts/harmonyos-sans.css">
  <link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;
      background: #111;
      color: #eee;
    }
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      padding: 8px 16px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #181818;
    }
    header h1 {
      font-size: 16px;
      margin: 0;
    }
    header small {
      font-size: 12px;
      color: #999;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 300px minmax(400px,1fr) 280px;
      min-height: 0;
    }
    .panel {
      padding: 10px;
      border-right: 1px solid #222;
      overflow-y: auto;
    }
    .panel-right {
      border-right: none;
      border-left: 1px solid #222;
      padding: 10px;
      overflow-y: auto;
    }
    h2 {
      font-size: 14px;
      margin: 6px 0;
    }
    h3 {
      font-size: 13px;
      margin: 4px 0;
    }
    label {
      font-size: 12px;
      display: block;
      margin-top: 6px;
      margin-bottom: 2px;
      color: #aaa;
    }
    input[type="number"], input[type="text"], select, textarea {
      width: 100%;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #181818;
      color: #eee;
      font-size: 12px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    input[type="file"] {
      font-size: 12px;
      width: 100%;
    }
    input[type="checkbox"] {
      margin-right: 6px;
    }
    button {
      padding: 4px 8px;
      margin-top: 6px;
      margin-right: 4px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #222;
      color: #eee;
      font-size: 12px;
      cursor: pointer;
    }
    button.primary {
      background: #007aff;
      border-color: #007aff;
    }
    button.danger {
      background: #9b111e;
      border-color: #9b111e;
    }
    button.success {
      background: #21C07C;
      border-color: #21C07C;
      color: #000;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .small {
      font-size: 12px;
      color: #888;
    }

    /* ç¼–è¾‘åŒºåŸŸ */
    .editor-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      background: #000;
      padding: 10px;
      overflow: auto;
    }
    .editor-toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #aaa;
    }
    .editor-toolbar input[type="range"] {
      width: 120px;
    }
    .editor-outer {
      position: relative;
      margin: 0 auto;
      border: 1px solid #333;
      background: #111;
      overflow: auto;
      max-height: calc(100vh - 120px);
    }
    .editor-inner {
      position: relative;
      transform-origin: top left;
    }
    #referenceImage {
      position: absolute;
      left: 0;
      top: 0;
      max-width: none; /* ä¿æŒåŸå§‹åƒç´  */
      image-rendering: pixelated;
      pointer-events: none;
    }
    #overlay {
      position: absolute;
      left: 0;
      top: 0;
    }
    .text-layer {
      position: absolute;
      white-space: pre;
      cursor: move;
      user-select: none;
      pointer-events: auto;
      text-shadow: 0 0 1px rgba(0,0,0,.8);
    }
    .text-layer.selected {
      outline: 1px dashed #00bcd4;
    }
    /* å­å±‚çº§å®¹å™¨ - æ°´å¹³æ’åˆ— */
    .text-layer-children {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      line-height: 1;
    }
    .text-layer-child {
      white-space: pre;
      line-height: 1;
      vertical-align: top;
    }
    .layer-list {
      border: 1px solid #333;
      border-radius: 4px;
      padding: 4px;
      max-height: 160px;
      overflow-y: auto;
      font-size: 12px;
    }
    .layer-item {
      padding: 2px 4px;
      border-radius: 3px;
      margin-bottom: 2px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .layer-item span {
      flex: 1;
    }
    .layer-item small {
      color: #666;
      margin-left: 4px;
    }
    .layer-item.active {
      background: #1e3a5f;
    }
    .layer-item button {
      margin: 0 0 0 4px;
      padding: 0 4px;
      font-size: 11px;
    }
    .row {
      display: flex;
      gap: 6px;
    }
    .row > div {
      flex: 1;
    }
    .calc-result {
      margin-top: 8px;
      padding: 6px;
      border-radius: 4px;
      background: #121212;
      border: 1px solid #333;
      font-size: 12px;
      line-height: 1.4;
    }
    hr {
      border: none;
      border-top: 1px solid #333;
      margin: 10px 0;
    }
    
    /* å­å±‚çº§ç¼–è¾‘åŒº */
    .children-section {
      margin-top: 8px;
      padding: 8px;
      background: #1a1a1a;
      border-radius: 4px;
      border: 1px solid #333;
    }
    .children-list {
      max-height: 120px;
      overflow-y: auto;
      margin-bottom: 6px;
    }
    .child-item {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px;
      margin-bottom: 4px;
      background: #222;
      border-radius: 3px;
      font-size: 11px;
    }
    .child-item.active {
      background: #1e3a5f;
    }
    .child-item input {
      flex: 1;
      padding: 2px 4px;
      font-size: 11px;
    }
    .child-item button {
      padding: 2px 6px;
      margin: 0;
      font-size: 10px;
    }
    .child-style-editor {
      margin-top: 6px;
      padding: 6px;
      background: #252525;
      border-radius: 3px;
    }
    .badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 10px;
      margin-left: 4px;
    }
    .badge-children {
      background: #4fc3f7;
      color: #000;
    }
    .badge-qrcode {
      background: #21C07C;
      color: #000;
    }
    /* äºŒç»´ç å›¾å±‚æ˜¾ç¤º */
    .qrcode-layer {
      position: absolute;
      border: 2px dashed #21C07C;
      background: #ffffff;
      cursor: move;
      overflow: hidden;
    }
    .qrcode-layer.selected {
      border-color: #00bcd4;
    }
    .qrcode-layer canvas,
    .qrcode-layer img {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>åˆçº¦æ¨¡æ‹Ÿè®¡ç®—å™¨ & æ™’å•æ¨¡æ¿ç¼–è¾‘å™¨</h1>
    <small>ç®­å¤´é”®åƒç´ çº§ç§»åŠ¨ Â· Shift+ç®­å¤´ 10 åƒç´  Â· æ”¯æŒå­å±‚çº§</small>
  </header>
  <main>
    <!-- å·¦ä¾§ï¼šå›¾ç‰‡ & ç¼–è¾‘æ§åˆ¶ -->
    <section class="panel">
      <h2>â‘  ä¸Šä¼ å‚è€ƒå›¾</h2>
      <label>å‚è€ƒå›¾ï¼ˆPNG / JPGï¼‰</label>
      <input type="file" id="imageInput" accept="image/png,image/jpeg,image/webp">

      <div class="small" style="margin-top:4px;">
        å»ºè®®ï¼šå…ˆæˆªä¸€å¼ çœŸå®äº¤æ˜“æ‰€çš„æ™’å•å›¾åŸå›¾ï¼Œç”¨å®ƒæ¥åšæ¨¡æ¿å¯¹é½ã€‚
      </div>

      <hr>

      <h2>â‘¡ æ–‡å­—å›¾å±‚æ§åˆ¶</h2>
      <button id="addTextLayerBtn" class="primary" disabled>æ·»åŠ æ–‡å­—å›¾å±‚</button>
      <button id="addQRCodeLayerBtn" class="success" disabled>æ·»åŠ äºŒç»´ç å›¾å±‚</button>
      <div class="small">å¯ä»¥å…ˆåŠ å›ºå®šæ–‡å­—ï¼Œå†åŠ å‡ ä¸ªå¯å˜æ•°å­— / æ—¥æœŸçš„ä½ç½®ã€‚äºŒç»´ç ç”¨äºé‚€è¯·é“¾æ¥ã€‚</div>

      <label style="margin-top:8px;">å›¾å±‚åˆ—è¡¨</label>
      <div id="layerList" class="layer-list"></div>

      <div id="layerEditor" style="margin-top:8px; display:none;">
        <h3>å½“å‰å›¾å±‚å±æ€§</h3>
        <label>å†…å®¹ï¼ˆæ”¯æŒå ä½ç¬¦ï¼Œå¦‚ {{price}}ï¼‰</label>
        <input type="text" id="layerTextInput">

        <div class="row">
          <div>
            <label>å­—ä½“</label>
            <select id="layerFontFamily">
              <option value="system-ui">ç³»ç»Ÿé»˜è®¤</option>
              <option value="HarmonyOS Sans SC">HarmonyOS Sans</option>
              <option value="Arial">Arial</option>
              <option value="PingFang SC">è‹¹æ–¹</option>
              <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
              <option value="Menlo">ç­‰å®½ Menlo</option>
            </select>
          </div>
          <div>
            <label>å­—å·(px)</label>
            <input type="number" id="layerFontSize" min="6" max="200" value="14">
          </div>
        </div>

        <div style="margin-top:8px; padding:8px; background:#1a1a1a; border-radius:4px;">
          <label style="margin-top:0;">æ·»åŠ åœ¨çº¿å­—ä½“ (Google Fonts)</label>
          <input type="text" id="googleFontUrl" placeholder="ç²˜è´´ Google Fonts é“¾æ¥ï¼Œå¦‚: https://fonts.googleapis.com/css2?family=Noto+Sans+SC">
          <button id="loadGoogleFontBtn" style="margin-top:4px;">åŠ è½½å­—ä½“</button>
          <div class="small" style="margin-top:4px;">
            ğŸ’¡ è®¿é—® <a href="https://fonts.google.com" target="_blank" style="color:#4fc3f7;">fonts.google.com</a> â†’ é€‰å­—ä½“ â†’ å¤åˆ¶é“¾æ¥<br>
            âš¡ ä¼šè‡ªåŠ¨è§£æå­—ä½“åç§°ï¼Œè‡ªåŠ¨æ·»åŠ å¯å˜å­—é‡æ”¯æŒ
          </div>
        </div>

        <div class="row">
          <div>
            <label>é¢œè‰²</label>
            <input type="text" id="layerColor" value="#ffffff" placeholder="#rrggbb">
          </div>
          <div>
            <label>å­—é‡ <span id="weightDisplay">400</span></label>
            <select id="layerWeight" style="width:100%;">
              <option value="100">100 - Thin æç»†</option>
              <option value="300">300 - Light ç»†</option>
              <option value="400" selected>400 - Regular å¸¸è§„</option>
              <option value="500">500 - Medium ä¸­ç­‰</option>
              <option value="700">700 - Bold ç²—</option>
              <option value="900">900 - Black ç‰¹ç²—</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>å­—é—´è·(px)</label>
            <input type="number" id="layerLetterSpacing" value="0" step="0.5">
          </div>
          <div>
            <label>è¡Œé«˜(å€)</label>
            <input type="number" id="layerLineHeight" value="1.2" step="0.1" min="0.5" max="3">
          </div>
        </div>

        <div class="row">
          <div>
            <label>X åƒç´ </label>
            <input type="number" id="layerX">
          </div>
          <div>
            <label>Y åƒç´ </label>
            <input type="number" id="layerY">
          </div>
        </div>
        
        <!-- å­å±‚çº§ç¼–è¾‘åŒº -->
        <div class="children-section">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">å­å±‚çº§ <span class="small">(æ°´å¹³æ’åˆ—)</span></h3>
            <button id="addChildBtn" class="success" style="margin:0; padding:2px 8px;">+ æ·»åŠ å­å…ƒç´ </button>
          </div>
          <div class="small" style="margin:4px 0;">
            å¯ç”¨å­å±‚çº§åï¼Œä¸»å†…å®¹å˜ä¸ºå®¹å™¨ï¼Œå­å…ƒç´ ä»å·¦åˆ°å³æ’åˆ—ï¼Œæ¯ä¸ªå­å…ƒç´ å¯ç‹¬ç«‹è®¾ç½®æ ·å¼
          </div>
          
          <div id="childrenList" class="children-list"></div>
          
          <div id="childStyleEditor" style="display:none;" class="child-style-editor">
            <h4 style="font-size:12px; margin:0 0 6px 0;">å­å…ƒç´ æ ·å¼</h4>
            <div class="row">
              <div>
                <label style="margin-top:0;">å†…å®¹</label>
                <input type="text" id="childText">
              </div>
              <div>
                <label style="margin-top:0;">é—´è·(px)</label>
                <input type="number" id="childGap" value="0" step="1">
              </div>
            </div>
            <div class="row">
              <div>
                <label>é¢œè‰² <span class="small">(ç•™ç©ºç»§æ‰¿)</span></label>
                <input type="text" id="childColor" placeholder="ç»§æ‰¿çˆ¶çº§">
              </div>
              <div>
                <label>å­—å· <span class="small">(ç•™ç©ºç»§æ‰¿)</span></label>
                <input type="number" id="childFontSize" placeholder="ç»§æ‰¿">
              </div>
            </div>
            <div class="row">
              <div>
                <label>å­—é‡ <span class="small">(ç•™ç©ºç»§æ‰¿)</span></label>
                <select id="childFontWeight" style="width:100%;">
                  <option value="">ç»§æ‰¿çˆ¶çº§</option>
                  <option value="100">100 - Thin</option>
                  <option value="300">300 - Light</option>
                  <option value="400">400 - Regular</option>
                  <option value="500">500 - Medium</option>
                  <option value="700">700 - Bold</option>
                  <option value="900">900 - Black</option>
                </select>
              </div>
              <div>
                <label>
                  <input type="checkbox" id="childDynamicColor">
                  åŠ¨æ€æ–¹å‘å˜è‰²
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- äºŒç»´ç å›¾å±‚ç¼–è¾‘å™¨ -->
      <div id="qrcodeEditor" style="margin-top:8px; display:none;">
        <h3>äºŒç»´ç å›¾å±‚å±æ€§ <span class="badge" style="background:#4fc3f7; color:#000;">QR</span></h3>
        <div class="small" style="margin-bottom:6px;">
          äºŒç»´ç å°†æ ¹æ®äº¤æ˜“æ‰€é…ç½®çš„é“¾æ¥ + é‚€è¯·ç ç”Ÿæˆï¼Œé‚€è¯·ç ç”¨ {{ref}} è¡¨ç¤º
        </div>
        
        <div class="row">
          <div>
            <label>X åƒç´ </label>
            <input type="number" id="qrcodeX">
          </div>
          <div>
            <label>Y åƒç´ </label>
            <input type="number" id="qrcodeY">
          </div>
        </div>
        
        <div class="row">
          <div>
            <label>å®½åº¦(px)</label>
            <input type="number" id="qrcodeWidth" value="100" min="50" max="300">
          </div>
          <div>
            <label>é«˜åº¦(px)</label>
            <input type="number" id="qrcodeHeight" value="100" min="50" max="300">
          </div>
        </div>
        
        <div style="margin-top:8px; padding:8px; background:#1a1a1a; border-radius:4px;">
          <label style="margin-top:0;">é¢„è§ˆé“¾æ¥ï¼ˆç”¨äºæœ¬åœ°é¢„è§ˆï¼‰</label>
          <input type="text" id="qrcodePreviewUrl" placeholder="è¾“å…¥é“¾æ¥é¢„è§ˆäºŒç»´ç æ•ˆæœ..." value="https://example.com/ref/PREVIEW">
          <button id="refreshQrcodeBtn" style="margin-top:4px; width:100%;">ğŸ”„ åˆ·æ–°é¢„è§ˆäºŒç»´ç </button>
          <div class="small" style="margin-top:4px;">
            âš ï¸ è¿™åªæ˜¯é¢„è§ˆç”¨çš„é“¾æ¥ï¼Œå®é™…ç”± API çš„ refcode å‚æ•° + äº¤æ˜“æ‰€ config.json é…ç½®çš„ baseUrl ç”Ÿæˆ
          </div>
        </div>
      </div>
    </section>

    <!-- ä¸­é—´ï¼šç”»å¸ƒç¼–è¾‘åŒºåŸŸ -->
    <section class="editor-wrapper">
      <div class="editor-toolbar">
        <span>å‚è€ƒå›¾é€æ˜åº¦</span>
        <input type="range" id="opacityRange" min="0" max="100" value="100">
        <span id="opacityValue">100%</span>

        <span style="margin-left:16px;">ç”»å¸ƒç¼©æ”¾</span>
        <input type="range" id="zoomRange" min="25" max="300" value="100">
        <span id="zoomValue">100%</span>

        <label style="margin-left:16px; display:flex; align-items:center; cursor:pointer;">
          <input type="checkbox" id="liveApiRender" style="margin-right:4px;">
          <span>ğŸ”´ å®æ—¶APIæ¸²æŸ“</span>
        </label>
        <span id="liveApiStatus" style="margin-left:8px; font-size:11px; color:#666;"></span>

        <button id="exportImageBtn" style="margin-left:auto;" disabled>ç”Ÿæˆæ™’å• PNG</button>
        <button id="exportViaApiBtn" style="margin-left:8px;" disabled title="ä½¿ç”¨åç«¯ API ç”Ÿæˆï¼Œä¸æ¥å£æ•ˆæœå®Œå…¨ä¸€è‡´">ğŸ”— APIç”Ÿæˆ</button>
      </div>

      <div class="editor-outer">
        <div id="editorInner" class="editor-inner">
          <img id="referenceImage" alt="">
          <div id="overlay"></div>
          <!-- API æ¸²æŸ“ç»“æœå åŠ å±‚ -->
          <img id="apiRenderOverlay" style="position:absolute; left:0; top:0; pointer-events:none; display:none; z-index:10;">
        </div>
      </div>
    </section>

    <!-- å³ä¾§ï¼šæ¨¡æ¿ JSON & è®¡ç®—å™¨ -->
    <section class="panel-right">
      <h2>â‘¢ æ¨¡æ¿å¯¼å…¥ / å¯¼å‡º</h2>
      <div class="small">
        å½“ä½ æŠŠæ‰€æœ‰æ–‡å­—ä½ç½®éƒ½è°ƒå¥½åï¼Œå¯¼å‡ºæ¨¡æ¿ JSONï¼Œå­˜æ•°æ®åº“å°±è¡Œã€‚åé¢åªè¦å¡«å˜é‡å°±å¯ä»¥ä¸€é”®ç”Ÿæˆæ™’å›¾ã€‚
      </div>

      <button id="exportTemplateBtn" style="margin-top:6px;" disabled>å¯¼å‡ºæ¨¡æ¿ JSON</button>
      <button id="importTemplateBtn" style="margin-top:6px;">å¯¼å…¥æ¨¡æ¿ JSON</button>

      <label style="margin-top:6px;">æ¨¡æ¿ JSON</label>
      <textarea id="templateJsonArea" placeholder='{"width":..., "height":..., "layers":[...]}'></textarea>

      <hr>

      <h2>â‘£ åˆçº¦ç›ˆäºæ¨¡æ‹Ÿè®¡ç®—å™¨</h2>
      <div class="row">
        <div>
          <label>æ–¹å‘</label>
          <select id="direction">
            <option value="long">åšå¤š</option>
            <option value="short">åšç©º</option>
          </select>
        </div>
        <div>
          <label>æ æ†</label>
          <input type="number" id="leverage" value="10" min="1">
        </div>
      </div>

      <label>å¼€ä»“ä»·</label>
      <input type="number" id="entryPrice" value="65000" step="0.0001">

      <label>å¹³ä»“ä»·</label>
      <input type="number" id="exitPrice" value="66000" step="0.0001">

      <label>åˆçº¦å¼ æ•° / æ•°é‡</label>
      <input type="number" id="quantity" value="1" step="0.0001">

      <label>åˆçº¦é¢å€¼ï¼ˆæ¯”å¦‚ 1 å¼  = 1 USDT é¢å€¼ï¼Œç•™ç©ºåˆ™ç”¨ 1ï¼‰</label>
      <input type="number" id="contractSize" placeholder="é»˜è®¤ 1" step="0.0001">

      <button id="calcBtn" class="primary">è®¡ç®—ç›ˆäº</button>

      <div id="calcResult" class="calc-result">
        ç­‰å¾…è¾“å…¥â€¦
      </div>

      <div class="small" style="margin-top:6px;">
        ä½ å¯ä»¥çº¦å®šæŸä¸ªæ–‡å­—å›¾å±‚å†…å®¹å†™æˆã€Œæ”¶ç›Šï¼š{{pnl}} USDTã€ï¼Œç„¶ååœ¨ç”Ÿæˆå›¾ç‰‡å‰ç”¨ JS æ›¿æ¢è¿™äº›å ä½ç¬¦ã€‚
      </div>

      <hr>

      <h2>â‘¤ API å®æ—¶é¢„è§ˆ</h2>
      <div class="small" style="margin-bottom:8px;">
        è¾“å…¥çœŸå®äº¤æ˜“å‚æ•°ï¼Œè°ƒç”¨ API å®æ—¶é¢„è§ˆæœ€ç»ˆç”Ÿæˆæ•ˆæœ
      </div>

      <div class="row">
        <div>
          <label>API æœåŠ¡å™¨</label>
          <input type="text" id="apiServer" value="http://localhost:3070" placeholder="http://localhost:3070">
        </div>
      </div>

      <div class="row">
        <div>
          <label>äº¤æ˜“æ‰€</label>
          <select id="apiExchange">
            <option value="easicoin">Easicoin</option>
            <option value="lbanken">LBanken</option>
          </select>
        </div>
        <div>
          <label>äº¤æ˜“å¯¹</label>
          <input type="text" id="apiTradepair" value="ETHUSDT" placeholder="ETHUSDT">
        </div>
      </div>

      <div class="row">
        <div>
          <label>å¼€ä»“æ—¶é—´</label>
          <input type="text" id="apiOpendate" placeholder="2025-12-01 10:00">
        </div>
        <div>
          <label>æ˜¾ç¤ºæ—¶é—´</label>
          <input type="text" id="apiDate" placeholder="2025-12-04 18:00">
        </div>
      </div>

      <div class="row">
        <div>
          <label>æ–¹å‘</label>
          <select id="apiDirection">
            <option value="long">åšå¤š (Long)</option>
            <option value="short">åšç©º (Short)</option>
          </select>
        </div>
        <div>
          <label>æ æ†</label>
          <input type="number" id="apiLev" value="50" min="1" max="500">
        </div>
      </div>

      <div class="row">
        <div>
          <label>æ—¶åŒº</label>
          <select id="apiTimezone">
            <option value="+8">UTC+8 åŒ—äº¬</option>
            <option value="+9">UTC+9 ä¸œäº¬</option>
            <option value="+0">UTC+0 ä¼¦æ•¦</option>
            <option value="-5">UTC-5 çº½çº¦</option>
            <option value="-8">UTC-8 æ´›æ‰çŸ¶</option>
          </select>
        </div>
        <div>
          <label style="display:flex; align-items:center; margin-top:20px;">
            <input type="checkbox" id="apiDynamicColor" checked>
            åŠ¨æ€æ–¹å‘å˜è‰²
          </label>
        </div>
      </div>

      <div style="display:flex; gap:6px; margin-top:8px;">
        <button id="apiPreviewBtn" class="primary" style="flex:1;">ğŸ”„ å®æ—¶é¢„è§ˆ</button>
        <button id="apiFillTimeBtn" style="flex:1;">â° å¡«å……æ—¶é—´</button>
      </div>

      <div id="apiPreviewResult" style="margin-top:8px; padding:8px; background:#121212; border:1px solid #333; border-radius:4px; min-height:60px; font-size:11px; color:#888; text-align:center;">
        ç‚¹å‡»ã€Œå®æ—¶é¢„è§ˆã€è°ƒç”¨ API ç”Ÿæˆå›¾ç‰‡
      </div>

      <div id="apiPreviewImage" style="margin-top:8px; text-align:center; display:none;">
        <img id="apiResultImg" style="max-width:100%; border-radius:4px; box-shadow:0 2px 10px rgba(0,0,0,0.5);">
        <div style="margin-top:4px;">
          <button id="apiDownloadBtn" class="success" style="font-size:11px;">â¬‡ï¸ ä¸‹è½½å›¾ç‰‡</button>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
(function() {
  // çŠ¶æ€
  let currentImage = null;
  let imageWidth = 0;
  let imageHeight = 0;
  let layers = [];
  let selectedLayerId = null;
  let selectedChildIndex = -1;  // å½“å‰é€‰ä¸­çš„å­å±‚çº§ç´¢å¼•
  let zoom = 1.0;

  const imageInput = document.getElementById('imageInput');
  const refImg = document.getElementById('referenceImage');
  const overlay = document.getElementById('overlay');
  const editorInner = document.getElementById('editorInner');

  const addTextLayerBtn = document.getElementById('addTextLayerBtn');
  const exportImageBtn = document.getElementById('exportImageBtn');
  const exportViaApiBtn = document.getElementById('exportViaApiBtn');
  const exportTemplateBtn = document.getElementById('exportTemplateBtn');
  const importTemplateBtn = document.getElementById('importTemplateBtn');
  const templateJsonArea = document.getElementById('templateJsonArea');

  const opacityRange = document.getElementById('opacityRange');
  const opacityValue = document.getElementById('opacityValue');
  const zoomRange = document.getElementById('zoomRange');
  const zoomValue = document.getElementById('zoomValue');

  const layerList = document.getElementById('layerList');
  const layerEditor = document.getElementById('layerEditor');
  const layerTextInput = document.getElementById('layerTextInput');
  const layerFontFamily = document.getElementById('layerFontFamily');
  const layerFontSize = document.getElementById('layerFontSize');
  const layerColor = document.getElementById('layerColor');
  const layerWeight = document.getElementById('layerWeight');
  const weightDisplay = document.getElementById('weightDisplay');
  const layerLetterSpacing = document.getElementById('layerLetterSpacing');
  const layerLineHeight = document.getElementById('layerLineHeight');
  const layerX = document.getElementById('layerX');
  const layerY = document.getElementById('layerY');

  // å­å±‚çº§ç›¸å…³
  const addChildBtn = document.getElementById('addChildBtn');
  const childrenList = document.getElementById('childrenList');
  const childStyleEditor = document.getElementById('childStyleEditor');
  const childText = document.getElementById('childText');
  const childGap = document.getElementById('childGap');
  const childColor = document.getElementById('childColor');
  const childFontSize = document.getElementById('childFontSize');
  const childFontWeight = document.getElementById('childFontWeight');
  const childDynamicColor = document.getElementById('childDynamicColor');

  // äºŒç»´ç å›¾å±‚ç›¸å…³
  const addQRCodeLayerBtn = document.getElementById('addQRCodeLayerBtn');
  const qrcodeEditor = document.getElementById('qrcodeEditor');
  const qrcodeX = document.getElementById('qrcodeX');
  const qrcodeY = document.getElementById('qrcodeY');
  const qrcodeWidth = document.getElementById('qrcodeWidth');
  const qrcodeHeight = document.getElementById('qrcodeHeight');
  const qrcodePreviewUrl = document.getElementById('qrcodePreviewUrl');
  const refreshQrcodeBtn = document.getElementById('refreshQrcodeBtn');
  let qrcodePreviewUrlValue = 'https://example.com/ref/PREVIEW';  // é¢„è§ˆé“¾æ¥

  // åœ¨çº¿å­—ä½“
  const googleFontUrl = document.getElementById('googleFontUrl');
  const loadGoogleFontBtn = document.getElementById('loadGoogleFontBtn');
  const loadedFontUrls = new Set();

  // è®¡ç®—å™¨
  const directionEl = document.getElementById('direction');
  const leverageEl = document.getElementById('leverage');
  const entryPriceEl = document.getElementById('entryPrice');
  const exitPriceEl = document.getElementById('exitPrice');
  const quantityEl = document.getElementById('quantity');
  const contractSizeEl = document.getElementById('contractSize');
  const calcBtn = document.getElementById('calcBtn');
  const calcResult = document.getElementById('calcResult');

  // å·¥å…·å‡½æ•°
  function genId() {
    return 'L' + Math.random().toString(36).slice(2, 9);
  }

  function ensureImageLoaded() {
    if (!currentImage) {
      alert('è¯·å…ˆä¸Šä¼ å‚è€ƒå›¾');
      return false;
    }
    return true;
  }

  function findLayer(id) {
    return layers.find(l => l.id === id) || null;
  }

  function renderEditorSize() {
    editorInner.style.width = imageWidth + 'px';
    editorInner.style.height = imageHeight + 'px';
    refImg.style.width = imageWidth + 'px';
    refImg.style.height = imageHeight + 'px';
    overlay.style.width = imageWidth + 'px';
    overlay.style.height = imageHeight + 'px';
  }

  function renderZoom() {
    editorInner.style.transform = 'scale(' + zoom + ')';
    zoomValue.textContent = Math.round(zoom * 100) + '%';
  }

  function renderLayersList() {
    layerList.innerHTML = '';
    if (layers.length === 0) {
      layerList.innerHTML = '<div class="small">æš‚æ— å›¾å±‚</div>';
      return;
    }
    layers.forEach((l, index) => {
      const div = document.createElement('div');
      div.className = 'layer-item' + (l.id === selectedLayerId ? ' active' : '');
      div.dataset.id = l.id;

      const span = document.createElement('span');
      if (l.type === 'qrcode') {
        // äºŒç»´ç å›¾å±‚
        span.innerHTML = `ğŸ“± äºŒç»´ç  <span class="badge badge-qrcode">QR</span>`;
      } else {
        // æ–‡å­—å›¾å±‚
        span.innerHTML = (l.text || '(ç©º)') + 
          (l.children && l.children.length > 0 ? `<span class="badge badge-children">${l.children.length}å­</span>` : '');
      }
      const pos = document.createElement('small');
      pos.textContent = l.type === 'qrcode' ? `(${l.x}, ${l.y}) ${l.width}x${l.height}` : `(${l.x}, ${l.y})`;

      const delBtn = document.createElement('button');
      delBtn.textContent = 'åˆ ';
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteLayer(l.id);
      });

      div.appendChild(span);
      div.appendChild(pos);
      div.appendChild(delBtn);

      div.addEventListener('click', () => {
        selectLayer(l.id);
      });

      layerList.appendChild(div);
    });
  }

  function renderChildrenList() {
    const layer = findLayer(selectedLayerId);
    childrenList.innerHTML = '';
    
    if (!layer || !layer.children || layer.children.length === 0) {
      childrenList.innerHTML = '<div class="small" style="padding:4px;">æš‚æ— å­å…ƒç´ ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
      childStyleEditor.style.display = 'none';
      return;
    }
    
    layer.children.forEach((child, idx) => {
      const div = document.createElement('div');
      div.className = 'child-item' + (idx === selectedChildIndex ? ' active' : '');
      
      const textSpan = document.createElement('span');
      textSpan.textContent = child.text || '(ç©º)';
      textSpan.style.flex = '1';
      textSpan.style.cursor = 'pointer';
      textSpan.addEventListener('click', () => {
        selectedChildIndex = idx;
        renderChildrenList();
        renderChildEditor();
      });
      
      const colorIndicator = document.createElement('span');
      colorIndicator.style.cssText = `width:12px; height:12px; border-radius:2px; background:${child.color || layer.color}; margin:0 4px;`;
      
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Ã—';
      delBtn.className = 'danger';
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        layer.children.splice(idx, 1);
        if (selectedChildIndex >= layer.children.length) {
          selectedChildIndex = layer.children.length - 1;
        }
        renderChildrenList();
        renderChildEditor();
        renderOverlay();
      });
      
      div.appendChild(textSpan);
      div.appendChild(colorIndicator);
      div.appendChild(delBtn);
      childrenList.appendChild(div);
    });
  }

  function renderChildEditor() {
    const layer = findLayer(selectedLayerId);
    if (!layer || !layer.children || selectedChildIndex < 0 || selectedChildIndex >= layer.children.length) {
      childStyleEditor.style.display = 'none';
      return;
    }
    
    childStyleEditor.style.display = 'block';
    const child = layer.children[selectedChildIndex];
    
    childText.value = child.text || '';
    childGap.value = child.gap || 0;
    childColor.value = child.color || '';
    childFontSize.value = child.fontSize || '';
    childFontWeight.value = child.fontWeight || '';
    childDynamicColor.checked = child.dynamicColor || false;
  }

  function renderLayerEditor() {
    const layer = findLayer(selectedLayerId);
    if (!layer) {
      layerEditor.style.display = 'none';
      qrcodeEditor.style.display = 'none';
      return;
    }
    
    // æ ¹æ®å›¾å±‚ç±»å‹æ˜¾ç¤ºä¸åŒçš„ç¼–è¾‘å™¨
    if (layer.type === 'qrcode') {
      // äºŒç»´ç å›¾å±‚ç¼–è¾‘å™¨
      layerEditor.style.display = 'none';
      qrcodeEditor.style.display = 'block';
      qrcodeX.value = layer.x;
      qrcodeY.value = layer.y;
      qrcodeWidth.value = layer.width || 100;
      qrcodeHeight.value = layer.height || 100;
      qrcodePreviewUrl.value = qrcodePreviewUrlValue;  // æ˜¾ç¤ºå½“å‰é¢„è§ˆé“¾æ¥
    } else {
      // æ–‡å­—å›¾å±‚ç¼–è¾‘å™¨
      qrcodeEditor.style.display = 'none';
      layerEditor.style.display = 'block';
      layerTextInput.value = layer.text;
      
      // æ£€æŸ¥å­—ä½“æ˜¯å¦åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­ï¼Œå¦‚æœä¸åœ¨åˆ™æ·»åŠ 
      let fontExists = false;
      for (const opt of layerFontFamily.options) {
        if (opt.value === layer.fontFamily) {
          fontExists = true;
          break;
        }
      }
      if (!fontExists && layer.fontFamily) {
        const newOpt = document.createElement('option');
        newOpt.value = layer.fontFamily;
        newOpt.textContent = layer.fontFamily + ' (å¯¼å…¥)';
        layerFontFamily.appendChild(newOpt);
      }
      layerFontFamily.value = layer.fontFamily;
      
      layerFontSize.value = layer.fontSize;
      layerColor.value = layer.color;
      
      // å…¼å®¹æ—§æ¨¡æ¿çš„ normal/bold
      let weight = layer.fontWeight;
      if (weight === 'normal') weight = 400;
      else if (weight === 'bold') weight = 700;
      else weight = parseInt(weight, 10) || 400;
      layerWeight.value = weight;
      weightDisplay.textContent = weight;
      layerLetterSpacing.value = layer.letterSpacing || 0;
      layerLineHeight.value = layer.lineHeight || 1.2;
      layerX.value = layer.x;
      layerY.value = layer.y;
      
      // æ¸²æŸ“å­å±‚çº§åˆ—è¡¨
      selectedChildIndex = (layer.children && layer.children.length > 0) ? 0 : -1;
      renderChildrenList();
      renderChildEditor();
    }
  }

  function renderOverlay() {
    overlay.innerHTML = '';
    layers.forEach(layer => {
      let el;
      
      // äºŒç»´ç å›¾å±‚
      if (layer.type === 'qrcode') {
        el = document.createElement('div');
        el.className = 'qrcode-layer' + (layer.id === selectedLayerId ? ' selected' : '');
        el.dataset.id = layer.id;
        el.style.left = layer.x + 'px';
        el.style.top = layer.y + 'px';
        el.style.width = layer.width + 'px';
        el.style.height = layer.height + 'px';
        
        // ç”Ÿæˆå ä½äºŒç»´ç é¢„è§ˆ
        const qrContainer = document.createElement('div');
        qrContainer.style.cssText = 'width: 100%; height: 100%;';
        el.appendChild(qrContainer);
        
        // å»¶è¿Ÿç”ŸæˆäºŒç»´ç ï¼ˆç­‰å¾… DOM æ’å…¥ï¼‰
        setTimeout(() => {
          if (typeof QRCode !== 'undefined' && qrContainer.parentElement) {
            qrContainer.innerHTML = '';  // æ¸…ç©º
            new QRCode(qrContainer, {
              text: qrcodePreviewUrlValue || 'https://example.com/ref/PREVIEW',
              width: layer.width - 4,
              height: layer.height - 4,
              colorDark: '#000000',
              colorLight: '#ffffff',
              correctLevel: QRCode.CorrectLevel.M
            });
          }
        }, 10);
      } else {
        // æ–‡å­—å›¾å±‚
        el = document.createElement('div');
        el.className = 'text-layer' + (layer.id === selectedLayerId ? ' selected' : '');
        el.dataset.id = layer.id;
        el.style.left = layer.x + 'px';
        el.style.top = layer.y + 'px';
        el.style.fontFamily = layer.fontFamily;
        el.style.color = layer.color;
        el.style.letterSpacing = (layer.letterSpacing || 0) + 'px';

        // å¦‚æœæœ‰å­å±‚çº§ï¼Œæ¸²æŸ“å­å±‚çº§ï¼ˆä¸è®¾ç½®å¤–å±‚ font-size/line-height é¿å…å½±å“å¸ƒå±€ï¼‰
        if (layer.children && layer.children.length > 0) {
          const childContainer = document.createElement('div');
          childContainer.className = 'text-layer-children';
          
          layer.children.forEach((child, idx) => {
            const childEl = document.createElement('span');
            childEl.className = 'text-layer-child';
            childEl.textContent = child.text || '';
            
            // å­å±‚çº§æ ·å¼ï¼ˆç»§æ‰¿æˆ–è¦†ç›–ï¼‰
            if (child.color) childEl.style.color = child.color;
            if (child.fontSize) childEl.style.fontSize = child.fontSize + 'px';
            if (child.fontWeight) childEl.style.fontWeight = child.fontWeight;
            if (child.gap && idx > 0) childEl.style.marginLeft = child.gap + 'px';
            
            childContainer.appendChild(childEl);
          });
          
          el.appendChild(childContainer);
        } else {
          // æ— å­å±‚çº§æ—¶è®¾ç½® font-size/line-height/fontWeight
          el.style.fontSize = layer.fontSize + 'px';
          el.style.fontWeight = layer.fontWeight;
          el.style.lineHeight = layer.lineHeight || 1.2;
          el.textContent = layer.text;
        }
      }

      // æ‹–æ‹½
      let dragging = false;
      let dragStartX = 0;
      let dragStartY = 0;
      let startLayerX = 0;
      let startLayerY = 0;

      el.addEventListener('mousedown', (e) => {
        e.preventDefault();
        selectLayer(layer.id);
        dragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        startLayerX = layer.x;
        startLayerY = layer.y;
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });

      const onMouseMove = (e) => {
        if (!dragging) return;
        const dx = (e.clientX - dragStartX) / zoom;
        const dy = (e.clientY - dragStartY) / zoom;
        layer.x = Math.round(startLayerX + dx);
        layer.y = Math.round(startLayerY + dy);
        renderOverlay();
        renderLayersList();
        renderLayerEditor();
      };

      const onMouseUp = () => {
        if (!dragging) return;
        dragging = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        
        // å¦‚æœå¯ç”¨äº†å®æ—¶ API æ¸²æŸ“ï¼Œæ‹–åŠ¨ç»“æŸåè°ƒç”¨ API
        if (liveApiRenderEnabled && currentImageBase64) {
          triggerLiveApiRender();
        }
      };

      overlay.appendChild(el);
    });
  }

  function selectLayer(id) {
    selectedLayerId = id;
    selectedChildIndex = -1;
    renderLayersList();
    renderOverlay();
    renderLayerEditor();
  }

  function addLayer(defaultText) {
    if (!ensureImageLoaded()) return;
    const layer = {
      id: genId(),
      text: defaultText || 'æ–°æ–‡å­—',
      x: Math.round(imageWidth / 2 - 40),
      y: Math.round(imageHeight / 2 - 8),
      fontFamily: 'system-ui',
      fontSize: 14,
      color: '#ffffff',
      fontWeight: 400,
      letterSpacing: 0,
      lineHeight: 1.2,
      children: []  // å­å±‚çº§æ•°ç»„
    };
    layers.push(layer);
    selectLayer(layer.id);
  }

  function deleteLayer(id) {
    layers = layers.filter(l => l.id !== id);
    if (selectedLayerId === id) selectedLayerId = null;
    renderLayersList();
    renderOverlay();
    renderLayerEditor();
  }

  function updateSelectedLayerFromInputs() {
    const layer = findLayer(selectedLayerId);
    if (!layer) return;
    layer.text = layerTextInput.value;
    layer.fontFamily = layerFontFamily.value;
    layer.fontSize = parseInt(layerFontSize.value, 10) || 14;
    layer.color = layerColor.value || '#ffffff';
    layer.fontWeight = parseInt(layerWeight.value, 10) || 400;
    weightDisplay.textContent = layer.fontWeight;
    layer.letterSpacing = parseFloat(layerLetterSpacing.value) || 0;
    layer.lineHeight = parseFloat(layerLineHeight.value) || 1.2;
    layer.x = parseInt(layerX.value, 10) || 0;
    layer.y = parseInt(layerY.value, 10) || 0;
    renderOverlay();
    renderLayersList();
    // è§¦å‘å®æ—¶ API æ¸²æŸ“
    if (liveApiRenderEnabled) triggerLiveApiRender();
  }

  function updateSelectedChildFromInputs() {
    const layer = findLayer(selectedLayerId);
    if (!layer || !layer.children || selectedChildIndex < 0) return;
    
    const child = layer.children[selectedChildIndex];
    child.text = childText.value;
    child.gap = parseInt(childGap.value, 10) || 0;
    child.color = childColor.value || null;
    child.fontSize = childFontSize.value ? parseInt(childFontSize.value, 10) : null;
    child.fontWeight = childFontWeight.value ? parseInt(childFontWeight.value, 10) : null;
    child.dynamicColor = childDynamicColor.checked;
    
    renderOverlay();
    renderChildrenList();
    // è§¦å‘å®æ—¶ API æ¸²æŸ“
    if (liveApiRenderEnabled) triggerLiveApiRender();
  }

  // æ·»åŠ å­å…ƒç´ 
  addChildBtn.addEventListener('click', () => {
    const layer = findLayer(selectedLayerId);
    if (!layer) return;
    
    if (!layer.children) layer.children = [];
    
    layer.children.push({
      text: 'å­å…ƒç´ ',
      gap: layer.children.length > 0 ? 4 : 0,
      color: null,
      fontSize: null,
      fontWeight: null,
      dynamicColor: false
    });
    
    selectedChildIndex = layer.children.length - 1;
    renderChildrenList();
    renderChildEditor();
    renderOverlay();
  });

  // å­å…ƒç´ å±æ€§è¾“å…¥äº‹ä»¶
  childText.addEventListener('input', updateSelectedChildFromInputs);
  childGap.addEventListener('input', updateSelectedChildFromInputs);
  childColor.addEventListener('input', updateSelectedChildFromInputs);
  childFontSize.addEventListener('input', updateSelectedChildFromInputs);
  childFontWeight.addEventListener('change', updateSelectedChildFromInputs);
  childDynamicColor.addEventListener('change', updateSelectedChildFromInputs);

  // ä¿å­˜åŸå§‹å›¾ç‰‡çš„ base64 æ•°æ®ï¼ˆç”¨äº API è°ƒç”¨ï¼‰
  let currentImageBase64 = null;
  
  // ==================== å®æ—¶ API æ¸²æŸ“åŠŸèƒ½ ====================
  const liveApiRender = document.getElementById('liveApiRender');
  const liveApiStatus = document.getElementById('liveApiStatus');
  const apiRenderOverlay = document.getElementById('apiRenderOverlay');
  let liveApiRenderEnabled = false;
  let liveApiRenderTimeout = null;
  
  // å®æ—¶ API æ¸²æŸ“å¼€å…³
  liveApiRender.addEventListener('change', () => {
    liveApiRenderEnabled = liveApiRender.checked;
    if (liveApiRenderEnabled) {
      liveApiStatus.textContent = 'å·²å¯ç”¨';
      liveApiStatus.style.color = '#21C07C';
      overlay.style.opacity = '0.3';  // é™ä½æœ¬åœ°æ¸²æŸ“é€æ˜åº¦
      apiRenderOverlay.style.display = 'block';
      // ç«‹å³è§¦å‘ä¸€æ¬¡æ¸²æŸ“
      if (currentImageBase64) {
        triggerLiveApiRender();
      }
    } else {
      liveApiStatus.textContent = '';
      overlay.style.opacity = '1';
      apiRenderOverlay.style.display = 'none';
    }
  });
  
  // è§¦å‘å®æ—¶ API æ¸²æŸ“ï¼ˆå¸¦é˜²æŠ–ï¼‰
  function triggerLiveApiRender() {
    if (!liveApiRenderEnabled || !currentImageBase64) return;
    
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (liveApiRenderTimeout) {
      clearTimeout(liveApiRenderTimeout);
    }
    
    liveApiStatus.textContent = 'ç­‰å¾…...';
    liveApiStatus.style.color = '#ffa500';
    
    // é˜²æŠ–ï¼š300ms åæ‰çœŸæ­£è°ƒç”¨ API
    liveApiRenderTimeout = setTimeout(async () => {
      await doLiveApiRender();
    }, 300);
  }
  
  // æ‰§è¡Œ API æ¸²æŸ“
  async function doLiveApiRender() {
    if (!currentImageBase64) return;
    
    liveApiStatus.textContent = 'æ¸²æŸ“ä¸­...';
    liveApiStatus.style.color = '#4fc3f7';
    
    try {
      // å‡†å¤‡æ¨¡æ¿æ•°æ®
      const templateData = {
        width: imageWidth,
        height: imageHeight,
        customFontUrls: Array.from(loadedFontUrls),
        layers: layers.map(l => {
          // äºŒç»´ç å›¾å±‚
          if (l.type === 'qrcode') {
            return {
              type: 'qrcode',
              x: l.x,
              y: l.y,
              width: l.width || 100,
              height: l.height || 100
            };
          }
          
          // æ–‡å­—å›¾å±‚
          const layerData = {
            text: l.text,
            x: l.x,
            y: l.y,
            fontFamily: l.fontFamily,
            fontSize: l.fontSize,
            fontWeight: l.fontWeight,
            color: l.color,
            letterSpacing: l.letterSpacing || 0,
            lineHeight: l.lineHeight || 1.2
          };
          if (l.children && l.children.length > 0) {
            layerData.children = l.children;
          }
          return layerData;
        }),
        baseImage: currentImageBase64
      };
      
      const startTime = Date.now();
      const response = await fetch('http://localhost:3070/api/render', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(templateData)
      });
      
      if (!response.ok) {
        throw new Error('æ¸²æŸ“å¤±è´¥');
      }
      
      // è·å–å›¾ç‰‡ blob å¹¶æ˜¾ç¤º
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      
      // é‡Šæ”¾æ—§çš„ URL
      if (apiRenderOverlay.src && apiRenderOverlay.src.startsWith('blob:')) {
        URL.revokeObjectURL(apiRenderOverlay.src);
      }
      
      apiRenderOverlay.src = url;
      apiRenderOverlay.style.width = imageWidth + 'px';
      apiRenderOverlay.style.height = imageHeight + 'px';
      
      const elapsed = Date.now() - startTime;
      liveApiStatus.textContent = `âœ“ ${elapsed}ms`;
      liveApiStatus.style.color = '#21C07C';
      
    } catch (err) {
      console.error('å®æ—¶æ¸²æŸ“å¤±è´¥:', err);
      liveApiStatus.textContent = 'âŒ å¤±è´¥';
      liveApiStatus.style.color = '#ff6b6b';
    }
  }
  
  // äº‹ä»¶ç»‘å®šï¼šå›¾ç‰‡ä¸Šä¼ 
  imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // ä½¿ç”¨ FileReader è¯»å–ä¸º data URLï¼ˆé¿å… canvas æ±¡æŸ“é—®é¢˜ï¼‰
    const reader = new FileReader();
    reader.onload = function(event) {
      const dataUrl = event.target.result;
      currentImageBase64 = dataUrl;  // ä¿å­˜ base64 ç”¨äº API
      
      const img = new Image();
      img.onload = function() {
        currentImage = img;
        imageWidth = img.naturalWidth;
        imageHeight = img.naturalHeight;
        refImg.src = dataUrl;
        renderEditorSize();
        addTextLayerBtn.disabled = false;
        addQRCodeLayerBtn.disabled = false;
        exportImageBtn.disabled = false;
        exportViaApiBtn.disabled = false;
        exportTemplateBtn.disabled = false;
        // é»˜è®¤ zoom 100%
        zoom = 1;
        zoomRange.value = 100;
        renderZoom();
      };
      img.src = dataUrl;
    };
    reader.readAsDataURL(file);
  });

  // é€æ˜åº¦ / ç¼©æ”¾
  opacityRange.addEventListener('input', () => {
    const v = parseInt(opacityRange.value, 10);
    refImg.style.opacity = v / 100;
    opacityValue.textContent = v + '%';
  });

  zoomRange.addEventListener('input', () => {
    const v = parseInt(zoomRange.value, 10);
    zoom = v / 100;
    renderZoom();
  });

  // æ·»åŠ æ–‡å­—å›¾å±‚
  addTextLayerBtn.addEventListener('click', () => {
    addLayer('æ–°æ–‡å­—');
  });

  // æ·»åŠ äºŒç»´ç å›¾å±‚
  addQRCodeLayerBtn.addEventListener('click', () => {
    addQRCodeLayer();
  });

  // æ·»åŠ äºŒç»´ç å›¾å±‚å‡½æ•°
  function addQRCodeLayer() {
    if (!ensureImageLoaded()) return;
    const layer = {
      id: genId(),
      type: 'qrcode',
      x: Math.round(imageWidth - 150),  // é»˜è®¤å³ä¸‹è§’
      y: Math.round(imageHeight - 150),
      width: 100,
      height: 100
    };
    layers.push(layer);
    selectLayer(layer.id);
  }

  // æ›´æ–°äºŒç»´ç å›¾å±‚å±æ€§
  function updateQRCodeLayerFromInputs() {
    const layer = findLayer(selectedLayerId);
    if (!layer || layer.type !== 'qrcode') return;
    layer.x = parseInt(qrcodeX.value, 10) || 0;
    layer.y = parseInt(qrcodeY.value, 10) || 0;
    layer.width = parseInt(qrcodeWidth.value, 10) || 100;
    layer.height = parseInt(qrcodeHeight.value, 10) || 100;
    renderOverlay();
    renderLayersList();
    // è§¦å‘å®æ—¶ API æ¸²æŸ“
    if (liveApiRenderEnabled) triggerLiveApiRender();
  }

  // äºŒç»´ç å›¾å±‚å±æ€§è¾“å…¥äº‹ä»¶
  qrcodeX.addEventListener('input', updateQRCodeLayerFromInputs);
  qrcodeY.addEventListener('input', updateQRCodeLayerFromInputs);
  qrcodeWidth.addEventListener('input', updateQRCodeLayerFromInputs);
  qrcodeHeight.addEventListener('input', updateQRCodeLayerFromInputs);
  
  // åˆ·æ–°é¢„è§ˆäºŒç»´ç 
  refreshQrcodeBtn.addEventListener('click', () => {
    qrcodePreviewUrlValue = qrcodePreviewUrl.value.trim() || 'https://example.com/ref/PREVIEW';
    renderOverlay();  // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°äºŒç»´ç 
  });

  // å›¾å±‚å±æ€§è¾“å…¥äº‹ä»¶
  layerTextInput.addEventListener('input', updateSelectedLayerFromInputs);
  layerFontFamily.addEventListener('change', updateSelectedLayerFromInputs);
  layerFontSize.addEventListener('input', updateSelectedLayerFromInputs);
  layerColor.addEventListener('input', updateSelectedLayerFromInputs);
  layerWeight.addEventListener('change', updateSelectedLayerFromInputs);
  layerLetterSpacing.addEventListener('input', updateSelectedLayerFromInputs);
  layerLineHeight.addEventListener('input', updateSelectedLayerFromInputs);
  layerX.addEventListener('input', updateSelectedLayerFromInputs);
  layerY.addEventListener('input', updateSelectedLayerFromInputs);

  // åŠ è½½ Google Fonts
  loadGoogleFontBtn.addEventListener('click', async () => {
    let url = googleFontUrl.value.trim();
    if (!url) {
      alert('è¯·è¾“å…¥ Google Fonts é“¾æ¥');
      return;
    }

    // éªŒè¯æ˜¯å¦æ˜¯ Google Fonts URL
    if (!url.includes('fonts.googleapis.com')) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ Google Fonts é“¾æ¥');
      return;
    }

    // ä» URL ä¸­è§£æå­—ä½“åç§°
    const familyMatch = url.match(/family=([^&:]+)/);
    if (!familyMatch) {
      alert('æ— æ³•ä»é“¾æ¥ä¸­è§£æå­—ä½“åç§°');
      return;
    }

    // è§£ç å­—ä½“åç§° (å¦‚ Noto+Sans+SC -> Noto Sans SC)
    const fontName = decodeURIComponent(familyMatch[1].replace(/\+/g, ' '));
    
    // è‡ªåŠ¨æ·»åŠ å¯å˜å­—é‡æ”¯æŒ
    if (!url.includes('wght@')) {
      url = url.replace(/family=([^&:]+)/, 'family=$1:wght@100..900');
      console.log('è‡ªåŠ¨æ·»åŠ å¯å˜å­—é‡:', url);
    }

    // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
    if (loadedFontUrls.has(url)) {
      alert('è¯¥å­—ä½“å·²åŠ è½½');
      layerFontFamily.value = fontName;
      updateSelectedLayerFromInputs();
      return;
    }

    // åŠ¨æ€åŠ è½½å­—ä½“
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = url;
    
    loadGoogleFontBtn.disabled = true;
    loadGoogleFontBtn.textContent = 'åŠ è½½ä¸­...';

    link.onload = () => {
      loadedFontUrls.add(url);
      
      // æ·»åŠ åˆ°ä¸‹æ‹‰é€‰é¡¹
      let exists = false;
      for (const opt of layerFontFamily.options) {
        if (opt.value === fontName) {
          exists = true;
          break;
        }
      }
      
      if (!exists) {
        const newOpt = document.createElement('option');
        newOpt.value = fontName;
        newOpt.textContent = fontName + ' (åœ¨çº¿)';
        layerFontFamily.appendChild(newOpt);
      }

      // é€‰ä¸­æ–°å­—ä½“
      layerFontFamily.value = fontName;
      updateSelectedLayerFromInputs();
      
      loadGoogleFontBtn.disabled = false;
      loadGoogleFontBtn.textContent = 'åŠ è½½å­—ä½“';
      googleFontUrl.value = '';
      
      alert('âœ… å­—ä½“åŠ è½½æˆåŠŸ: ' + fontName + '\n\nå·²è‡ªåŠ¨æ·»åŠ å¯å˜å­—é‡æ”¯æŒ (100-900)');
    };

    link.onerror = () => {
      loadGoogleFontBtn.disabled = false;
      loadGoogleFontBtn.textContent = 'åŠ è½½å­—ä½“';
      alert('âŒ å­—ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®');
    };

    document.head.appendChild(link);
  });

  // é”®ç›˜æ–¹å‘ç§»åŠ¨
  document.addEventListener('keydown', (e) => {
    const layer = findLayer(selectedLayerId);
    if (!layer) return;
    const arrows = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'];
    if (!arrows.includes(e.key)) return;

    e.preventDefault();
    const step = e.shiftKey ? 10 : 1;
    switch (e.key) {
      case 'ArrowUp':
        layer.y -= step;
        break;
      case 'ArrowDown':
        layer.y += step;
        break;
      case 'ArrowLeft':
        layer.x -= step;
        break;
      case 'ArrowRight':
        layer.x += step;
        break;
    }
    renderOverlay();
    renderLayersList();
    renderLayerEditor();
    // è§¦å‘å®æ—¶ API æ¸²æŸ“
    if (liveApiRenderEnabled) triggerLiveApiRender();
  });

  // å¯¼å‡ºæ¨¡æ¿ - å…¼å®¹æ—§æ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰ children åˆ™ä¸å¯¼å‡º
  exportTemplateBtn.addEventListener('click', () => {
    if (!ensureImageLoaded()) return;
    const tpl = {
      width: imageWidth,
      height: imageHeight,
      customFontUrls: Array.from(loadedFontUrls),
      layers: layers.map(l => {
        // äºŒç»´ç å›¾å±‚
        if (l.type === 'qrcode') {
          return {
            id: l.id,
            type: 'qrcode',
            x: l.x,
            y: l.y,
            width: l.width || 100,
            height: l.height || 100
          };
        }
        
        // æ–‡å­—å›¾å±‚
        const layerData = {
          id: l.id,
          text: l.text,
          x: l.x,
          y: l.y,
          fontFamily: l.fontFamily,
          fontSize: l.fontSize,
          color: l.color,
          fontWeight: l.fontWeight,
          letterSpacing: l.letterSpacing || 0,
          lineHeight: l.lineHeight || 1.2
        };
        
        // åªæœ‰åœ¨æœ‰å­å±‚çº§æ—¶æ‰å¯¼å‡º children
        if (l.children && l.children.length > 0) {
          layerData.children = l.children.map(c => {
            const childData = { text: c.text };
            if (c.gap) childData.gap = c.gap;
            if (c.color) childData.color = c.color;
            if (c.fontSize) childData.fontSize = c.fontSize;
            if (c.fontWeight) childData.fontWeight = c.fontWeight;
            if (c.dynamicColor) childData.dynamicColor = c.dynamicColor;
            return childData;
          });
        }
        
        return layerData;
      })
    };
    templateJsonArea.value = JSON.stringify(tpl, null, 2);
  });

  // å¯¼å…¥æ¨¡æ¿
  importTemplateBtn.addEventListener('click', () => {
    let txt = templateJsonArea.value.trim();
    if (!txt) {
      alert('è¯·å…ˆåœ¨æ–‡æœ¬æ¡†ä¸­ç²˜è´´æ¨¡æ¿ JSON');
      return;
    }
    try {
      const tpl = JSON.parse(txt);
      if (!tpl.width || !tpl.height || !Array.isArray(tpl.layers)) {
        alert('JSON ç»“æ„ä¸åˆæ³•');
        return;
      }
      if (!ensureImageLoaded()) {
        alert('è¯·å…ˆä¸Šä¼ ä¸€å¼ å‚è€ƒå›¾ï¼ˆå°ºå¯¸æœ€å¥½ä¸æ¨¡æ¿ä¸€è‡´ï¼‰');
        return;
      }
      imageWidth = tpl.width;
      imageHeight = tpl.height;
      renderEditorSize();
      layers = tpl.layers.map(l => {
        // äºŒç»´ç å›¾å±‚
        if (l.type === 'qrcode') {
          return {
            id: l.id || genId(),
            type: 'qrcode',
            x: l.x || 0,
            y: l.y || 0,
            width: l.width || 100,
            height: l.height || 100
          };
        }
        
        // æ–‡å­—å›¾å±‚ - å…¼å®¹æ—§æ¨¡æ¿çš„ normal/bold
        let weight = l.fontWeight;
        if (weight === 'normal') weight = 400;
        else if (weight === 'bold') weight = 700;
        else weight = parseInt(weight, 10) || 400;
        
        return {
          id: l.id || genId(),
          text: l.text || '',
          x: l.x || 0,
          y: l.y || 0,
          fontFamily: l.fontFamily || 'system-ui',
          fontSize: l.fontSize || 14,
          color: l.color || '#ffffff',
          fontWeight: weight,
          letterSpacing: l.letterSpacing || 0,
          lineHeight: l.lineHeight || 1.2,
          children: l.children || []  // æ”¯æŒå­å±‚çº§
        };
      });
      
      // å¦‚æœæ¨¡æ¿åŒ…å«è‡ªå®šä¹‰å­—ä½“ URLï¼ŒåŠ è½½å®ƒä»¬
      if (Array.isArray(tpl.customFontUrls)) {
        tpl.customFontUrls.forEach(url => {
          if (url && !loadedFontUrls.has(url)) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = url;
            document.head.appendChild(link);
            loadedFontUrls.add(url);
          }
        });
      }
      selectedLayerId = layers[0]?.id || null;
      renderLayersList();
      renderOverlay();
      renderLayerEditor();
    } catch (err) {
      console.error(err);
      alert('è§£æ JSON å¤±è´¥ï¼š' + err.message);
    }
  });

  // ç”Ÿæˆå›¾å±‚ HTMLï¼ˆæ”¯æŒå­å±‚çº§ï¼‰
  function generateLayerHTML(layer) {
    const baseStyle = `
      position: absolute;
      left: ${layer.x}px;
      top: ${layer.y}px;
      font-family: ${layer.fontFamily};
      font-size: ${layer.fontSize}px;
      font-weight: ${layer.fontWeight};
      color: ${layer.color};
      letter-spacing: ${layer.letterSpacing || 0}px;
      line-height: ${layer.lineHeight || 1.2};
      white-space: pre;
      user-select: none;
      text-shadow: 0 0 1px rgba(0,0,0,.8);
    `;
    
    if (layer.children && layer.children.length > 0) {
      // æœ‰å­å±‚çº§ï¼Œæ¸²æŸ“ä¸º flex å®¹å™¨
      let childrenHTML = '';
      layer.children.forEach((child, idx) => {
        let childStyle = '';
        if (child.color) childStyle += `color: ${child.color};`;
        if (child.fontSize) childStyle += `font-size: ${child.fontSize}px;`;
        if (child.fontWeight) childStyle += `font-weight: ${child.fontWeight};`;
        if (child.gap && idx > 0) childStyle += `margin-left: ${child.gap}px;`;
        
        const text = (child.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        childrenHTML += `<span style="${childStyle}">${text}</span>`;
      });
      
      return `<div style="${baseStyle}"><div style="display:flex;flex-direction:row;align-items:baseline;">${childrenHTML}</div></div>`;
    } else {
      // æ— å­å±‚çº§ï¼Œç›´æ¥æ¸²æŸ“æ–‡æœ¬
      const text = (layer.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return `<div style="${baseStyle}">${text}</div>`;
    }
  }

  // å¯¼å‡ºå›¾ç‰‡ - åˆ›å»ºç‹¬ç«‹æ¸²æŸ“å®¹å™¨ï¼Œç¡®ä¿ä¸é¢„è§ˆä½ç½®å®Œå…¨ä¸€è‡´
  exportImageBtn.addEventListener('click', async () => {
    if (!ensureImageLoaded()) return;
    
    exportImageBtn.disabled = true;
    exportImageBtn.textContent = 'ç”Ÿæˆä¸­...';
    
    try {
      // ç­‰å¾…å­—ä½“å®Œå…¨åŠ è½½
      await document.fonts.ready;
      
      // ç”Ÿæˆè‡ªå®šä¹‰å­—ä½“çš„ CSS
      const fontImports = loadedFontUrls.size > 0 
        ? Array.from(loadedFontUrls).map(url => `@import url('${url}');`).join('\n')
        : '';
      
      // ç”Ÿæˆæ–‡å­—å›¾å±‚ HTMLï¼ˆæ”¯æŒå­å±‚çº§ï¼‰
      let layersHTML = '';
      layers.forEach(l => {
        layersHTML += generateLayerHTML(l);
      });
      
      // åˆ›å»ºç‹¬ç«‹çš„æ¸²æŸ“å®¹å™¨
      const renderContainer = document.createElement('div');
      renderContainer.id = 'exportContainer';
      renderContainer.style.cssText = `
        position: fixed;
        left: -9999px;
        top: 0;
        width: ${imageWidth}px;
        height: ${imageHeight}px;
        overflow: hidden;
        z-index: -9999;
      `;
      
      // å†…éƒ¨æ¸²æŸ“åŒºåŸŸ
      const innerDiv = document.createElement('div');
      innerDiv.style.cssText = `position: relative; width: ${imageWidth}px; height: ${imageHeight}px; background: #000;`;
      innerDiv.innerHTML = `
        <style>${fontImports}</style>
        <img src="${refImg.src}" style="position: absolute; left: 0; top: 0; width: ${imageWidth}px; height: ${imageHeight}px;" />
        <div style="position: absolute; left: 0; top: 0; width: ${imageWidth}px; height: ${imageHeight}px;">
          ${layersHTML}
        </div>
      `;
      
      renderContainer.appendChild(innerDiv);
      document.body.appendChild(renderContainer);
      
      // ç­‰å¾…æ¸²æŸ“
      await new Promise(r => setTimeout(r, 800));
      await document.fonts.ready;
      
      // ä½¿ç”¨ html2canvas æˆªå–
      const canvas = await html2canvas(innerDiv, {
        width: imageWidth,
        height: imageHeight,
        scale: 1,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#000',
        logging: false
      });
      
      // æ¸…ç†
      document.body.removeChild(renderContainer);
      
      // ä¸‹è½½
      const dataURL = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataURL;
      a.download = 'contract-mock.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      console.log('âœ… å¯¼å‡ºæˆåŠŸ');
      
    } catch (err) {
      console.error('å¯¼å‡ºå¤±è´¥:', err);
      alert('å¯¼å‡ºå¤±è´¥: ' + err.message);
    } finally {
      exportImageBtn.disabled = false;
      exportImageBtn.textContent = 'ç”Ÿæˆæ™’å• PNG';
    }
  });

  // ä½¿ç”¨åç«¯ API ç”Ÿæˆå›¾ç‰‡ï¼ˆä¸æ¥å£æ•ˆæœå®Œå…¨ä¸€è‡´ï¼‰
  exportViaApiBtn.addEventListener('click', async () => {
    if (!ensureImageLoaded()) return;
    
    exportViaApiBtn.disabled = true;
    exportViaApiBtn.textContent = 'ç”Ÿæˆä¸­...';
    
    try {
      // ä½¿ç”¨ä¿å­˜çš„ base64 å›¾ç‰‡æ•°æ®
      if (!currentImageBase64) {
        alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
        return;
      }
      
      console.log('åº•å›¾å‰ç¼€:', currentImageBase64.substring(0, 50));
      console.log('åº•å›¾é•¿åº¦:', currentImageBase64.length);
      
      // å‡†å¤‡æ¨¡æ¿æ•°æ® - è½¬æ¢ä¸ºå…¼å®¹æ ¼å¼
      const templateData = {
        width: imageWidth,
        height: imageHeight,
        customFontUrls: Array.from(loadedFontUrls),
        layers: layers.map(l => {
          const layerData = {
            text: l.text,
            x: l.x,
            y: l.y,
            fontFamily: l.fontFamily,
            fontSize: l.fontSize,
            fontWeight: l.fontWeight,
            color: l.color,
            letterSpacing: l.letterSpacing || 0,
            lineHeight: l.lineHeight || 1.2
          };
          
          // åŒ…å«å­å±‚çº§
          if (l.children && l.children.length > 0) {
            layerData.children = l.children;
          }
          
          return layerData;
        }),
        baseImage: currentImageBase64  // ä¼ é€’ base64 å›¾ç‰‡
      };
      
      // è°ƒç”¨åç«¯ API
      const response = await fetch('http://localhost:3070/api/render', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(templateData)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'ç”Ÿæˆå¤±è´¥');
      }
      
      // ä¸‹è½½å›¾ç‰‡
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'contract-mock-api.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      console.log('âœ… API å¯¼å‡ºæˆåŠŸ');
      
    } catch (err) {
      console.error('API å¯¼å‡ºå¤±è´¥:', err);
      alert('API å¯¼å‡ºå¤±è´¥: ' + err.message + '\n\nè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ (node server.js)');
    } finally {
      exportViaApiBtn.disabled = false;
      exportViaApiBtn.textContent = 'ğŸ”— APIç”Ÿæˆ';
    }
  });

  // ç®€å•ç›ˆäºè®¡ç®—
  calcBtn.addEventListener('click', () => {
    const direction = directionEl.value; // long / short
    const leverage = parseFloat(leverageEl.value) || 1;
    const entry = parseFloat(entryPriceEl.value);
    const exit = parseFloat(exitPriceEl.value);
    const qty = parseFloat(quantityEl.value);
    const cSize = parseFloat(contractSizeEl.value) || 1;

    if (!(entry > 0 && exit > 0 && qty > 0 && leverage > 0)) {
      calcResult.textContent = 'è¯·å¡«å†™æœ‰æ•ˆçš„ä»·æ ¼/æ•°é‡/æ æ†';
      return;
    }

    const dir = direction === 'long' ? 1 : -1;
    const pnl = (exit - entry) * qty * cSize * dir;
    const notional = entry * qty * cSize;
    const margin = notional / leverage;
    const roe = margin > 0 ? (pnl / margin) * 100 : 0;

    const pnlStr = pnl.toFixed(2);
    const roeStr = roe.toFixed(2);

    calcResult.innerHTML =
      `ç›ˆäºï¼š<b>${pnlStr}</b> USDT<br>` +
      `ROEï¼š<b>${roeStr}%</b><br>` +
      `åä¹‰ä»·å€¼ï¼š${notional.toFixed(2)} USDT<br>` +
      `ä¿è¯é‡‘ï¼ˆçº¦ï¼‰ï¼š${margin.toFixed(2)} USDT`;

    // ç¤ºä¾‹ï¼šä½ å¯ä»¥åœ¨è¿™é‡Œåšå˜é‡æ›¿æ¢ï¼Œæ›´æ–°æŸä¸ªå›¾å±‚å†…å®¹
    // æ¯”å¦‚ï¼ŒæŠŠæ‰€æœ‰ {{pnl}} æ›¿æ¢æˆå®é™…æ•°å€¼ï¼š
    layers.forEach(l => {
      if (l.text && l.text.includes('{{pnl}}')) {
        l.text = l.text.replace(/{{pnl}}/g, pnlStr);
      }
      if (l.text && l.text.includes('{{roe}}')) {
        l.text = l.text.replace(/{{roe}}/g, roeStr);
      }
    });
    renderOverlay();
    renderLayersList();
  });

  // ==================== API å®æ—¶é¢„è§ˆåŠŸèƒ½ ====================
  const apiServer = document.getElementById('apiServer');
  const apiExchange = document.getElementById('apiExchange');
  const apiTradepair = document.getElementById('apiTradepair');
  const apiOpendate = document.getElementById('apiOpendate');
  const apiDate = document.getElementById('apiDate');
  const apiDirection = document.getElementById('apiDirection');
  const apiLev = document.getElementById('apiLev');
  const apiTimezone = document.getElementById('apiTimezone');
  const apiDynamicColor = document.getElementById('apiDynamicColor');
  const apiPreviewBtn = document.getElementById('apiPreviewBtn');
  const apiFillTimeBtn = document.getElementById('apiFillTimeBtn');
  const apiPreviewResult = document.getElementById('apiPreviewResult');
  const apiPreviewImage = document.getElementById('apiPreviewImage');
  const apiResultImg = document.getElementById('apiResultImg');
  const apiDownloadBtn = document.getElementById('apiDownloadBtn');

  let lastApiImageUrl = null;

  // å¡«å……æ—¶é—´æŒ‰é’®
  apiFillTimeBtn.addEventListener('click', () => {
    const now = new Date();
    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    const formatDT = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const h = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return `${y}-${m}-${day} ${h}:${min}`;
    };
    
    apiOpendate.value = formatDT(yesterday);
    apiDate.value = formatDT(now);
  });

  // åˆå§‹åŒ–æ—¶å¡«å……æ—¶é—´
  apiFillTimeBtn.click();

  // API å®æ—¶é¢„è§ˆ
  apiPreviewBtn.addEventListener('click', async () => {
    const server = apiServer.value.trim();
    const ex = apiExchange.value;
    const tradepair = apiTradepair.value.trim();
    const opendate = apiOpendate.value.trim();
    const date = apiDate.value.trim();
    const direction = apiDirection.value;
    const lev = apiLev.value;
    const timezone = apiTimezone.value;
    const dynamicColor = apiDynamicColor.checked;

    if (!tradepair || !opendate || !date) {
      apiPreviewResult.innerHTML = '<span style="color:#ff6b6b;">âŒ è¯·å¡«å†™äº¤æ˜“å¯¹ã€å¼€ä»“æ—¶é—´ã€æ˜¾ç¤ºæ—¶é—´</span>';
      return;
    }

    apiPreviewBtn.disabled = true;
    apiPreviewBtn.textContent = 'â³ åŠ è½½ä¸­...';
    apiPreviewResult.innerHTML = '<span style="color:#4fc3f7;">ğŸ”„ æ­£åœ¨è°ƒç”¨ API...</span>';
    apiPreviewImage.style.display = 'none';

    try {
      // æ„å»º URL
      const params = new URLSearchParams();
      params.set('ex', ex);
      params.set('tradepair', tradepair);
      params.set('opendate', opendate);
      params.set('date', date);
      params.set('direction', direction);
      params.set('lev', lev);
      if (timezone !== '+8') params.set('timezone', timezone);
      if (dynamicColor) params.set('dynamic_direction_color', 'true');

      const url = `${server}/api/generate?${params.toString()}`;
      console.log('API è¯·æ±‚:', url);

      const startTime = Date.now();
      const response = await fetch(url, {
        headers: { 'ngrok-skip-browser-warning': 'true' }
      });

      const elapsed = Date.now() - startTime;
      const result = await response.json();

      if (result.success && result.data?.image) {
        // æˆåŠŸ
        lastApiImageUrl = result.data.image;
        apiResultImg.src = result.data.image;
        apiPreviewImage.style.display = 'block';
        
        const info = result.tradeInfo || {};
        apiPreviewResult.innerHTML = `
          <span style="color:#21C07C;">âœ… ç”ŸæˆæˆåŠŸ (${elapsed}ms)</span><br>
          <span style="color:#aaa;">
            ${info.direction || ''} | ${info.leverage || lev}x | æ”¶ç›Š: ${info.yield || '-'}
          </span>
        `;
      } else {
        // å¤±è´¥
        apiPreviewResult.innerHTML = `<span style="color:#ff6b6b;">âŒ ${result.message || result.error || 'ç”Ÿæˆå¤±è´¥'}</span>`;
        apiPreviewImage.style.display = 'none';
      }

    } catch (err) {
      console.error('API è¯·æ±‚å¤±è´¥:', err);
      apiPreviewResult.innerHTML = `<span style="color:#ff6b6b;">âŒ è¯·æ±‚å¤±è´¥: ${err.message}<br>è¯·ç¡®ä¿ API æœåŠ¡å·²å¯åŠ¨</span>`;
      apiPreviewImage.style.display = 'none';
    } finally {
      apiPreviewBtn.disabled = false;
      apiPreviewBtn.textContent = 'ğŸ”„ å®æ—¶é¢„è§ˆ';
    }
  });

  // ä¸‹è½½ API ç”Ÿæˆçš„å›¾ç‰‡
  apiDownloadBtn.addEventListener('click', () => {
    if (!lastApiImageUrl) return;
    
    const a = document.createElement('a');
    a.href = lastApiImageUrl;
    a.download = `${apiTradepair.value}-${apiExchange.value}-${Date.now()}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  // ç›‘å¬äº¤æ˜“æ‰€åˆ‡æ¢ï¼Œè‡ªåŠ¨åˆ·æ–°é¢„è§ˆ
  apiExchange.addEventListener('change', () => {
    // å¯é€‰ï¼šè‡ªåŠ¨è§¦å‘é¢„è§ˆ
    // apiPreviewBtn.click();
  });

})();
</script>
</body>
</html>
