# æœ€ç»ˆä¿®å¤è¯´æ˜ - æµè§ˆå™¨ä¸Šä¸‹æ–‡é—®é¢˜

## ğŸ” é—®é¢˜è¯Šæ–­

### é”™è¯¯ä¿¡æ¯
```
ç”Ÿæˆå›¾ç‰‡å¤±è´¥,å·²é‡è¯• 2 æ¬¡: browser.newContext: Target page, context or browser has been closed
```

### æ ¹æœ¬åŸå› 

1. **æµè§ˆå™¨å®ä¾‹æ£€æŸ¥ä¸å½»åº•**ï¼šä»…ä½¿ç”¨ `browser.version()` æ£€æŸ¥ï¼Œæ— æ³•æ£€æµ‹åˆ°ä¸Šä¸‹æ–‡çº§åˆ«çš„é”™è¯¯
2. **åˆ›å»º context æ—¶ç¼ºå°‘ä¿æŠ¤**ï¼šæ²¡æœ‰åœ¨åˆ›å»ºå‰éªŒè¯æµè§ˆå™¨çŠ¶æ€
3. **é”™è¯¯æ¢å¤ä¸å¤ŸåŠæ—¶**ï¼šåªåœ¨å®Œå…¨å¤±è´¥åæ‰é‡ç½®æµè§ˆå™¨

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æ”¹è¿›æµè§ˆå™¨å¥åº·æ£€æŸ¥

**ä¹‹å‰**ï¼š
```javascript
await browser.version(); // ä¸å¤Ÿå¯é 
```

**ç°åœ¨**ï¼š
```javascript
// å°è¯•åˆ›å»ºä¸€ä¸ªæµ‹è¯• context æ¥éªŒè¯æµè§ˆå™¨æ˜¯å¦å¯ç”¨
const testContext = await browser.newContext();
await testContext.close();
```

è¿™ç§æ–¹å¼æ›´å¯é ï¼Œå› ä¸ºï¼š
- ç›´æ¥éªŒè¯æµè§ˆå™¨æ˜¯å¦èƒ½åˆ›å»ºä¸Šä¸‹æ–‡
- å¦‚æœæµè§ˆå™¨æœ‰é—®é¢˜ï¼Œä¼šç«‹å³æŠ›å‡ºé”™è¯¯
- æ£€æµ‹åˆ°é—®é¢˜åç«‹å³æ¸…ç†

### 2. åŒé‡éªŒè¯æœºåˆ¶

```javascript
async function ensureBrowser() {
  // ç¬¬ä¸€å±‚ï¼šæ£€æŸ¥æµè§ˆå™¨å®ä¾‹æ˜¯å¦å­˜åœ¨
  if (browser) {
    try {
      // ç¬¬äºŒå±‚ï¼šå°è¯•åˆ›å»ºæµ‹è¯• context éªŒè¯
      const testContext = await browser.newContext();
      await testContext.close();
      return browser;
    } catch (e) {
      // æµè§ˆå™¨æœ‰é—®é¢˜ï¼Œé‡ç½®
      browser = null;
    }
  }
  // é‡æ–°å¯åŠ¨æµè§ˆå™¨
}
```

### 3. Context åˆ›å»ºä¿æŠ¤

åœ¨åˆ›å»º context æ—¶æ·»åŠ é¢å¤–ä¿æŠ¤ï¼š

```javascript
try {
  context = await browser.newContext({...});
} catch (contextError) {
  // å¦‚æœå¤±è´¥ï¼Œç«‹å³é‡ç½®æµè§ˆå™¨
  browser = null;
  throw error;
}
```

### 4. æµè§ˆå™¨å¯åŠ¨å‚æ•°ä¼˜åŒ–

æ·»åŠ æ›´å¤šç¨³å®šæ€§å‚æ•°ï¼š

```javascript
browser = await chromium.launch({
  headless: true,
  args: [
    '--no-sandbox',
    '--disable-setuid-sandbox',
    '--disable-dev-shm-usage',
    '--disable-accelerated-2d-canvas',
    '--no-first-run',
    '--no-zygote',
    '--disable-gpu'
  ]
});
```

### 5. æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹

æ–°å¢ `/api/health` ç«¯ç‚¹ï¼Œæ–¹ä¾¿å¿«é€Ÿè¯Šæ–­ï¼š

```bash
curl https://your-domain.com/api/health
```

è¿”å›ï¼š
```json
{
  "status": "healthy",
  "browser": "running",
  "port": 3070,
  "timestamp": "2025-12-03T09:23:57.299Z"
}
```

## ğŸ§ª æµ‹è¯•ç»“æœ

### æœ¬åœ°æµ‹è¯•

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3070/api/health
# âœ… è¿”å› healthy

# ç”Ÿæˆå›¾ç‰‡
curl "http://localhost:3070/api/generate?tradepair=ETHUSDT&opendate=2025-12-02%2017:20&date=2025-12-03%2017:20&direction=long&lev=50"
# âœ… æˆåŠŸè¿”å› JSON
```

### å…¬å…±åŸŸåæµ‹è¯•

ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬ï¼š

```bash
./test-public-api.sh
```

æˆ–è€…æ‰‹åŠ¨æµ‹è¯•ï¼š

```bash
curl -H "ngrok-skip-browser-warning: true" \
  "https://nathalie-clothlike-urgently.ngrok-free.dev/api/generate?tradepair=ETHUSDT&opendate=2025-12-02%2017:20&date=2025-12-03%2017:20&direction=long&lev=50"
```

## ğŸ“‹ æ”¹è¿›ç‚¹æ€»ç»“

| æ”¹è¿›é¡¹ | è¯´æ˜ |
|--------|------|
| æµè§ˆå™¨å¥åº·æ£€æŸ¥ | ä½¿ç”¨å®é™… context åˆ›å»ºéªŒè¯ï¼Œæ›´å¯é  |
| åŒé‡éªŒè¯ | å­˜åœ¨æ€§æ£€æŸ¥ + åŠŸèƒ½æ€§éªŒè¯ |
| Context ä¿æŠ¤ | åˆ›å»ºå¤±è´¥æ—¶ç«‹å³é‡ç½®æµè§ˆå™¨ |
| å¯åŠ¨å‚æ•°ä¼˜åŒ– | æ·»åŠ æ›´å¤šç¨³å®šæ€§å‚æ•° |
| å¥åº·æ£€æŸ¥ç«¯ç‚¹ | ä¾¿äºå¿«é€Ÿè¯Šæ–­æœåŠ¡çŠ¶æ€ |
| é”™è¯¯é‡è¯•æœºåˆ¶ | è‡ªåŠ¨é‡è¯• 2 æ¬¡ï¼Œå¤±è´¥æ—¶é‡ç½®æµè§ˆå™¨ |

## ğŸ”§ ç»´æŠ¤å»ºè®®

### ç›‘æ§æµè§ˆå™¨çŠ¶æ€

å®šæœŸæ£€æŸ¥æœåŠ¡æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹æœåŠ¡è¿›ç¨‹
ps aux | grep "node server.js"

# æŸ¥çœ‹ç«¯å£
lsof -ti:3070
```

### å¥åº·æ£€æŸ¥

å®šæœŸè°ƒç”¨å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š

```bash
curl http://localhost:3070/api/health
```

### å¦‚æœé—®é¢˜å†æ¬¡å‡ºç°

1. æ£€æŸ¥æµè§ˆå™¨è¿›ç¨‹æ˜¯å¦å¼‚å¸¸
2. æŸ¥çœ‹æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µï¼ˆå†…å­˜ã€CPUï¼‰
3. é‡å¯æœåŠ¡ï¼š`lsof -ti:3070 | xargs kill -9 && node server.js`

## ğŸš€ æœåŠ¡çŠ¶æ€

- âœ… **æœ¬åœ°åœ°å€**: http://localhost:3070
- âœ… **å…¬å…±åŸŸå**: https://nathalie-clothlike-urgently.ngrok-free.dev
- âœ… **å¥åº·æ£€æŸ¥**: http://localhost:3070/api/health
- âœ… **æµè§ˆå™¨**: Playwright Chromiumï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰

## ğŸ“ ä½¿ç”¨å»ºè®®

1. **å‰ç«¯è°ƒç”¨æ—¶æ·»åŠ è¯·æ±‚å¤´**ï¼š
   ```javascript
   headers: {
     'ngrok-skip-browser-warning': 'true'
   }
   ```

2. **é”™è¯¯å¤„ç†**ï¼š
   ```javascript
   if (!response.success) {
     console.error('ç”Ÿæˆå¤±è´¥:', response.message);
     // å¯ä»¥é‡è¯•
   }
   ```

3. **å¥åº·æ£€æŸ¥**ï¼š
   åœ¨è°ƒç”¨å‰å¯ä»¥å…ˆæ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€

## âœ¨ æµ‹è¯•è„šæœ¬

ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬å¿«é€ŸéªŒè¯ï¼š

```bash
# åŸºç¡€æµ‹è¯•
./test-public-api.sh

# æ˜¾ç¤ºå®Œæ•´å“åº”
./test-public-api.sh --full
```



